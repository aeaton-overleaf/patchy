<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>patchy</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #0f172a; color: #e2e8f0; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 20px; }
    h1 { margin: 0 0 16px; font-size: 1.5rem; }
    .controls { display: flex; gap: 10px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
    input[type="file"] { border: 1px solid #334155; border-radius: 6px; padding: 8px; background: #1e293b; color: #e2e8f0; }
    .toggle { display: inline-flex; gap: 6px; align-items: center; color: #cbd5e1; font-size: 0.9rem; }
    button { border: 1px solid #334155; border-radius: 6px; padding: 8px 12px; background: #1e293b; color: #e2e8f0; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .hint { color: #94a3b8; font-size: 0.9rem; }
    .howto { color: #94a3b8; font-size: 0.85rem; margin: 0 0 14px; }
    .howto code { color: #e2e8f0; background: #1e293b; border: 1px solid #334155; border-radius: 4px; padding: 2px 6px; }
    .file { border: 1px solid #334155; border-radius: 8px; overflow: hidden; margin-bottom: 16px; background: #111827; }
    .file-header { padding: 10px 12px; background: #1f2937; border-bottom: 1px solid #334155; font-weight: 600; }
    .hunk { border-top: 1px solid #1f2937; }
    .hunk-header { background: #172554; color: #bfdbfe; padding: 6px 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 0.85rem; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 0; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 0.85rem; line-height: 1.4; }
    .cell { padding: 4px 10px; white-space: pre-wrap; word-break: break-word; border-top: 1px solid #1f2937; }
    .num { color: #64748b; margin-right: 10px; display: inline-block; min-width: 3ch; }
    .ctx { background: #0f172a; color: #cbd5e1; }
    .add { background: #052e16; color: #86efac; }
    .del { background: #450a0a; color: #fca5a5; }
    .empty { background: #0b1220; }
    .token-del, .token-add { border-radius: 3px; }
    .token-del { background: rgba(239, 68, 68, 0.25); }
    .token-add { background: rgba(34, 197, 94, 0.25); }
    .char-del { background: rgba(239, 68, 68, 0.55); }
    .char-add { background: rgba(34, 197, 94, 0.55); }
    .error { color: #fecaca; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>patchy</h1>
    <div class="controls">
      <input id="patchFile" type="file" accept=".diff,text/plain">
      <button id="downloadHtml" type="button" disabled>Download HTML</button>
      <label class="toggle"><input id="highlightUnchanged" type="checkbox" checked> Highlight unchanged text</label>
      <span class="hint">Open a unified diff file to view side-by-side changes.</span>
    </div>
    <p class="howto">Generate a compatible diff with <code>diff -u file-before.md file-after.md &gt; file.diff</code>.</p>
    <div id="error" class="error" role="alert"></div>
    <div id="output"></div>
  </div>

  <script>
    const input = document.getElementById("patchFile");
    const downloadButton = document.getElementById("downloadHtml");
    const highlightUnchangedInput = document.getElementById("highlightUnchanged");
    const output = document.getElementById("output");
    const errorBox = document.getElementById("error");
    let currentPatchName = "diff-view";
    let currentParsedFiles = [];

    downloadButton.addEventListener("click", () => {
      const style = document.querySelector("style")?.textContent || "";
      const title = `${currentPatchName} - patchy`;
      const html = `<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>${escapeHtml(title)}</title>
  <style>${style}</style>
</head>
<body>
  <div class="wrap">
    <h1>${escapeHtml(title)}</h1>
    <div id="output">${output.innerHTML}</div>
  </div>
</body>
</html>`;
      const blob = new Blob([html], { type: "text/html;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `${currentPatchName || "diff-view"}.html`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    });

    input.addEventListener("change", async (event) => {
      const [file] = event.target.files || [];
      output.innerHTML = "";
      errorBox.textContent = "";
      downloadButton.disabled = true;
      currentParsedFiles = [];
      if (!file) return;
      currentPatchName = file.name.replace(/\.[^.]+$/, "") || "diff-view";
      try {
        const text = await file.text();
        const parsed = parsePatch(text);
        currentParsedFiles = parsed;
        renderPatch(parsed, { highlightUnchanged: highlightUnchangedInput.checked });
        downloadButton.disabled = !parsed.length;
      } catch (err) {
        errorBox.textContent = err instanceof Error ? err.message : "Failed to parse diff.";
      }
    });

    highlightUnchangedInput.addEventListener("change", () => {
      if (!currentParsedFiles.length) return;
      renderPatch(currentParsedFiles, { highlightUnchanged: highlightUnchangedInput.checked });
    });

    function parsePatch(text) {
      const lines = text.replace(/\r\n/g, "\n").split("\n");
      const files = [];
      let currentFile = null;
      let currentHunk = null;

      for (const line of lines) {
        if (line.startsWith("diff --git ")) {
          currentFile = { oldPath: "", newPath: "", hunks: [] };
          files.push(currentFile);
          currentHunk = null;
          continue;
        }
        if (!currentFile && (line.startsWith("--- ") || line.startsWith("+++ ") || line.startsWith("@@ "))) {
          currentFile = { oldPath: "", newPath: "", hunks: [] };
          files.push(currentFile);
        }
        if (!currentFile) continue;

        if (line.startsWith("--- ")) {
          currentFile.oldPath = line.slice(4).trim();
          continue;
        }
        if (line.startsWith("+++ ")) {
          currentFile.newPath = line.slice(4).trim();
          continue;
        }
        if (line.startsWith("@@ ")) {
          currentHunk = { header: line, lines: [] };
          currentFile.hunks.push(currentHunk);
          continue;
        }
        if (currentHunk && /^[ +\-]/.test(line) && !line.startsWith("--- ") && !line.startsWith("+++ ")) {
          currentHunk.lines.push({ type: line[0], text: line.slice(1) });
        }
      }
      return files.filter((f) => f.hunks.length > 0);
    }

    function renderPatch(files, options = { highlightUnchanged: true }) {
      if (!files.length) {
        output.textContent = "No hunks found in this diff file.";
        return;
      }
      output.innerHTML = "";
      const frag = document.createDocumentFragment();
      for (const file of files) {
        const fileNode = el("section", "file");
        const title = file.newPath || file.oldPath || "(unknown file)";
        fileNode.appendChild(el("div", "file-header", escapeHtml(title)));
        for (const hunk of file.hunks) {
          const hunkNode = el("div", "hunk");
          hunkNode.appendChild(el("div", "hunk-header", escapeHtml(hunk.header)));
          for (const row of buildRows(hunk.lines, options)) {
            hunkNode.appendChild(row);
          }
          fileNode.appendChild(hunkNode);
        }
        frag.appendChild(fileNode);
      }
      output.appendChild(frag);
    }

    function buildRows(lines, options) {
      const rows = [];
      let i = 0;
      while (i < lines.length) {
        const line = lines[i];
        if (line.type === " ") {
          rows.push(renderRow({ leftClass: "ctx", left: line.text, rightClass: "ctx", right: line.text }));
          i += 1;
          continue;
        }

        if (line.type === "-") {
          const removed = [];
          const added = [];
          while (i < lines.length && lines[i].type === "-") {
            removed.push(lines[i].text);
            i += 1;
          }
          while (i < lines.length && lines[i].type === "+") {
            added.push(lines[i].text);
            i += 1;
          }
          const paired = Math.min(removed.length, added.length);
          for (let p = 0; p < paired; p += 1) {
            const inline = diffInline(removed[p], added[p]);
            const leftClass = options.highlightUnchanged ? "del" : "ctx";
            const rightClass = options.highlightUnchanged ? "add" : "ctx";
            rows.push(renderRow({
              leftClass,
              left: inline.left,
              rightClass,
              right: inline.right,
              isHtml: true
            }));
          }
          for (let p = paired; p < removed.length; p += 1) {
            rows.push(renderRow({ leftClass: "del", left: escapeHtml(removed[p]), rightClass: "empty", right: "", isHtml: true }));
          }
          for (let p = paired; p < added.length; p += 1) {
            rows.push(renderRow({ leftClass: "empty", left: "", rightClass: "add", right: escapeHtml(added[p]), isHtml: true }));
          }
          continue;
        }

        if (line.type === "+") {
          rows.push(renderRow({ leftClass: "empty", left: "", rightClass: "add", right: escapeHtml(line.text), isHtml: true }));
          i += 1;
          continue;
        }

        i += 1;
      }
      return rows;
    }

    function diffInline(left, right) {
      const leftTokens = tokenize(left);
      const rightTokens = tokenize(right);
      const ops = lcsDiff(leftTokens, rightTokens);
      let leftHtml = "";
      let rightHtml = "";
      for (const op of ops) {
        if (op.type === "equal") {
          leftHtml += escapeHtml(op.left.join(""));
          rightHtml += escapeHtml(op.right.join(""));
        } else if (op.type === "delete") {
          leftHtml += `<span class="token-del">${escapeHtml(op.left.join(""))}</span>`;
        } else if (op.type === "insert") {
          rightHtml += `<span class="token-add">${escapeHtml(op.right.join(""))}</span>`;
        } else {
          const charOps = lcsDiff([...op.left.join("")], [...op.right.join("")]);
          leftHtml += `<span class="token-del">${renderChars(charOps, "left")}</span>`;
          rightHtml += `<span class="token-add">${renderChars(charOps, "right")}</span>`;
        }
      }
      return { left: leftHtml, right: rightHtml };
    }

    function tokenize(line) {
      return line.match(/(\s+|[^\s]+)/g) || [];
    }

    function lcsDiff(a, b) {
      const n = a.length;
      const m = b.length;
      const dp = Array.from({ length: n + 1 }, () => Array(m + 1).fill(0));
      for (let i = n - 1; i >= 0; i -= 1) {
        for (let j = m - 1; j >= 0; j -= 1) {
          dp[i][j] = a[i] === b[j] ? dp[i + 1][j + 1] + 1 : Math.max(dp[i + 1][j], dp[i][j + 1]);
        }
      }

      const ops = [];
      let i = 0;
      let j = 0;
      while (i < n || j < m) {
        if (i < n && j < m && a[i] === b[j]) {
          ops.push({ type: "equal", left: [a[i]], right: [b[j]] });
          i += 1;
          j += 1;
        } else if (j === m || (i < n && dp[i + 1][j] >= dp[i][j + 1])) {
          ops.push({ type: "delete", left: [a[i]], right: [] });
          i += 1;
        } else {
          ops.push({ type: "insert", left: [], right: [b[j]] });
          j += 1;
        }
      }

      const merged = [];
      for (const op of ops) {
        const prev = merged[merged.length - 1];
        if (prev && prev.type === op.type) {
          prev.left.push(...op.left);
          prev.right.push(...op.right);
        } else {
          merged.push({ type: op.type, left: [...op.left], right: [...op.right] });
        }
      }

      const collapsed = [];
      for (let k = 0; k < merged.length; k += 1) {
        const cur = merged[k];
        const next = merged[k + 1];
        if (cur.type === "delete" && next && next.type === "insert") {
          collapsed.push({ type: "replace", left: cur.left, right: next.right });
          k += 1;
        } else {
          collapsed.push(cur);
        }
      }
      return collapsed;
    }

    function renderChars(ops, side) {
      let html = "";
      for (const op of ops) {
        if (op.type === "equal") {
          html += escapeHtml((side === "left" ? op.left : op.right).join(""));
        } else if (op.type === "delete" && side === "left") {
          html += `<span class="char-del">${escapeHtml(op.left.join(""))}</span>`;
        } else if (op.type === "insert" && side === "right") {
          html += `<span class="char-add">${escapeHtml(op.right.join(""))}</span>`;
        } else if (op.type === "replace") {
          const chars = side === "left" ? op.left.join("") : op.right.join("");
          html += `<span class="${side === "left" ? "char-del" : "char-add"}">${escapeHtml(chars)}</span>`;
        }
      }
      return html;
    }

    function renderRow({ leftClass, left, rightClass, right, isHtml = false }) {
      const row = el("div", "row");
      const leftCell = document.createElement("div");
      const rightCell = document.createElement("div");
      leftCell.className = `cell ${leftClass}`;
      rightCell.className = `cell ${rightClass}`;
      if (isHtml) {
        leftCell.innerHTML = left;
        rightCell.innerHTML = right;
      } else {
        leftCell.textContent = left;
        rightCell.textContent = right;
      }
      row.append(leftCell, rightCell);
      return row;
    }

    function el(tag, className, html = "") {
      const node = document.createElement(tag);
      if (className) node.className = className;
      if (html) node.innerHTML = html;
      return node;
    }

    function escapeHtml(text) {
      return text
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
